---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(plyr)
library(tidyverse)
```


# 24/07/2024

A estratégia é:
1) geocodificar os cnes de todos os hospitais de notificação do ano de 2022-2023 de SRAG - FEITO
2) contabilizar a proporção de sucesso
3) contabilizar o erro fora do MSP

## geocodificação dos endereços:
a) obter as coordenadas pela api da plataforma HERE
b) dos que não foi possível obter lat long pela plataforma HERE então eu pesquisei no google maps a coordenada 

```{r filtro dos cnes de interesse}
# 1) quais os cnes dos hospitais de notificação: remover casos duplicados
oname <- load("G:/CCD/CVE/RESPIRATORIAS/01_SRAG/4_bases/boletim.Rdata")
df_srag <- get(oname);rm(list=oname);gc()
df_geocod <- df_srag %>% filter(anoepi%in%2022:2023) %>% 
  select(ID_MN_RESI,CO_MUN_RES,# 
         ID_MUNICIP,CO_MUN_NOT,
         ID_UNIDADE,CO_UNI_NOT,
         DT_NOTIFIC,NU_NOTIFIC) %>% 
  rename(ID_MN_NOT = ID_MUNICIP,
         CNES = CO_UNI_NOT,
         NM_UNI_NOT=ID_UNIDADE) %>% 
  rename_with(tolower)
df_geocodMSP <- df_geocod %>% filter(co_mun_not=="355030")
v_cnes <- df_geocodMSP$cnes %>% unique
# 2) esses cnes estão presentes na tabela de referência da Denise?
df_refcnes <- read_csv("G:/CCD/CVE/RESPIRATORIAS/CNES_2022_2023/dados_CNES_2223_MSP.csv")
df_refcnes <- df_refcnes %>% select(MUNICIPIO,CNES,LOGRADOURO:CEP) %>% 
  rename_with(.,tolower)
v_cnes_soltos <- setdiff(v_cnes,unique(df_refcnes$cnes))
df_geocodMSP <- left_join(
  df_geocodMSP,
  df_refcnes
) %>% relocate(municipio,.after=last_col())
```
```{r geocodificacao per se}
library(tidygeocoder)
f_paste <- paste
formals(f_paste)$sep=", "
df_togeocod <- df_geocodMSP %>% select(cnes,logradouro:municipio) %>% distinct()
df_togeocod$endereco = Reduce("f_paste",df_togeocod[,-1])
# df_cnes <- df_togeocod %>% 
#   geocode(address = endereco,method="osm")
# names(df_cnes)[grepl("lat|long",names(df_cnes))] <- sapply(1:2,\(x) paste0(c("lat","long"),x)) %>% as.vector()
# df_cnes <- as.data.frame(df_cnes)
# # df_cnes <- df_togeocod
# saveRDS(df_cnes,file="./resultados/df_cnes.rds",)
#
# HERE_API_KEY = "satAmDy2WRSF25bYxXicCaM8olNeM8GB5YA15wAwAUM"
Sys.setenv(HERE_API_KEY = "satAmDy2WRSF25bYxXicCaM8olNeM8GB5YA15wAwAUM")
# df_cnes <- readRDS(file="./resultados/df_cnes.rds")
# df_aud <- df_cnes %>% filter(if_any(matches("lat|long"),is.na)) %>% select(cnes,endereco,matches("lat|long"))
#
df_aud <- df_togeocod %>% select(cnes,endereco) %>% 
  geocode(address = endereco, method="here")
df_cnes_latlong <- df_aud %>% select(cnes,endereco,lat,long) %>% as.data.frame()
#
# df_cnes_latlong <- left_join(
#   df_cnes,
#   df_geocodHERE %>% select(-endereco),
#   by="cnes"
# ) %>% mutate(
#   lat = ifelse(is.na(lat),lat1,lat),
#   long = ifelse(is.na(long),long1,long)
# ) %>% select(-matches("1|2")) %>% select(cnes,endereco:long)
saveRDS(df_cnes_latlong,file="./resultados/df_cnes_latlong.rds")
```
```{r preenchimento dos lat long q nao estavam na plataforma here}
df_cnes_latlong <- readRDS(df_cnes_latlong,file="./resultados/df_cnes_latlong.rds")
df_aud <- df_cnes_latlong %>% filter(grepl("NA, NA",endereco)|is.na(lat)|is.na(long)) %>% mutate(lat_long_gmaps=NA)
for(i in 1:nrow(df_aud)){
  gmaps_coords <- readline(prompt = paste("lat, long do cnes", df_aud[i,"cnes"], ": "))
  df_aud$lat_long_gmaps[i] <- gmaps_coords
}
df_aud <- df_aud %>%
  select(-lat,-long) %>% 
  separate(lat_long_gmaps, into = c("lat", "long"), sep = ", ")
df_final <- rbind(
  df_cnes_latlong %>% filter(!cnes%in%df_aud$cnes) %>% mutate(method="here"),
  df_aud %>% mutate(method="gmaps")
)
df_cnes_latlong <- df_final
saveRDS(df_cnes_latlong,file="./resultados/df_cnes_latlong.rds")
```
```{r geocode reverso para avaliar se existe o lugar}
# validação 
df_aud <- adply(df_cnes_latlong,1,\(dfi){
  reverse_geocode(dfi,lat=lat,long=long,method="here")
})
teste <- df_aud %>% 
  mutate(endereco = case_when(
    grepl("NA, NA",endereco) ~ address,
    TRUE ~ endereco
  )) %>% select(-address)
```

## Em qual grande área do MSP os hospitais notificantes estão?

```{r}

```






# 22/07/2024
Como descrever os dados de SP por distrito?



```{r estudo das variaveis do SIVEP relacionadas com localização}
oname <- load("G:/CCD/CVE/RESPIRATORIAS/01_SRAG/4_bases/boletim.Rdata")
df_srag <- get(oname);rm(list=oname);gc()
df_MSP <- df_srag %>% 
  filter(ID_MN_RESI=="SAO PAULO")

v_cols <- c("ID_REGIONA","CO_REGIONA","ID_MUNICIP","CO_MUN_NOT","ID_UNIDADE","CO_UNI_NOT",
            "NU_CEP","ID_PAIS","CO_PAIS","SG_UF","ID_RG_RESI","CO_RG_RESI","ID_MN_RESI",
            "CO_MUN_RES","NM_BAIRRO","NM_LOGRADO","NU_NUMERO","NM_COMPLEM","NU_DDD_TEL","NU_TELEFON",
            "CS_ZONA","ESTRANG","POV_CT","TP_POV_CT","NU_CNS","HOSPITAL","DT_INTERNA","SG_UF_INTE",
            "ID_RG_INTE","CO_RG_INTE","ID_MN_INTE","CO_MU_INTE","NM_UN_INTE","CO_UN_INTE")
v_endereco <- c("NU_CEP","NM_BAIRRO","NM_LOGRADO","NU_NUMERO","ID_MN_RESI")
df_aud <- df_MSP %>% select(all_of(v_endereco),"DT_SIN_PRI","classi")
df_aud


df_aud$NU_CEP %>% is.na() %>% sum() / length(df_aud$NU_CEP)
df_aud$NU_CEP %>% is.na() %>% sum()

df_srag %>% filter(classi!="SARS COV 2") %>% dim
```



```{r estudo do Rdata geocodificado pela Raquel}
oname <- load("C:/Users/dpmori/Desktop/trabalho_em_andamento/Geo_covid_030724.Rdata")
df_geocod <- get(oname);rm(list=oname);gc()
df_geocod %>% filter(Geo=="ok") %>% dim


v_cols <- c("NU_NOTIFIC","NU_CEP","Logradouro_Completo","Logradouro2","NM_LOGRADO","NU_NUMERO","ID_MN_RESI",
            "Cep","Geo","x","y","zip",
            "GEO2", "Tipo_log","Tipo_log2","Cep")
df_aud <- df_geocod %>% select(all_of(v_cols)) %>% filter(Geo=="ok")
```




```{r}
# Token de acesso: 0c19e6965ac3fea7d388b498e5b9bc40
library(cepR)
token <- "0c19e6965ac3fea7d388b498e5b9bc40"
v_cep <- df_aud %>% filter(!is.na(NU_CEP)) %>% head(n=10)
busca_cep(cep = "11920000",token = token)
# nunca funciona
```



Como geocodificar?

https://www.youtube.com/watch?v=vVuiBY2kMlA

```{r}
library(tibble)
library(dplyr)
library(tidygeocoder)
# library(maptools)
library(mapview)

v_cep$Logradouro_Completo[4]
geocode(address = v_cep$Logradouro_Completo[4])

```


